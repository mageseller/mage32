<?php
/**
 * Mageseller
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Mageseller.com license that is
 * available through the world-wide-web at this URL:
 * https://www.mageseller.com/LICENSE.txt
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    Mageseller
 * @package     Mageseller_Customization
 * @copyright   Copyright (c) 2017 Mageseller (http://www.mageseller.com/)
 * @license     https://www.mageseller.com/LICENSE.txt
 */
?>

<?php if ($block->isSelectAttribute()): ?>
	<div id="devices-attribute-popup">
		<div class="messages">
			<div id="devices-attribute-popup-success" class="message message-success success" style="display: none">
				<div class="content" data-ui-id="messages-message-success"></div>
			</div>
			<div id="devices-attribute-popup-error" class="message message-error error" style="display: none">
				<div class="content" data-ui-id="messages-message-error"></div>
			</div>
		</div>
		<div id="devices-attribute-popup-content"></div>
	</div>
	<script type="text/javascript">
		require([
			"jquery",
			'Magento_Ui/js/modal/confirm',
			'mage/mage',
			"Magento_Ui/js/modal/modal"
		], function($, confirm){
			var currentOption = 0,
				successMessage = '#devices-attribute-popup-success',
				errorMessage = '#devices-attribute-popup-error',
				devicesModal = $('#devices-attribute-popup').modal({
					title: $.mage.__('Custom Configuration'),
					type: 'slide',
					buttons: [{
							text: $.mage.__('Save'),
							'class': 'action-primary devices-save-button',
							click: function (event) {
								var form = $('#devices_attribute_save'),
									action = form.attr("action"),
									data = new FormData(form[0]);

								$(successMessage).hide();
								$(errorMessage).hide();

								if(form.valid()) {
									$.ajax({
										url: action,
										type: 'POST',
										data: data,
										mimeType: "multipart/form-data",
										showLoader: true,
										contentType: false,
										cache: false,
										processData: false,
										success: function (response) {
											var result = $.parseJSON(response);
											if (result.success) {
												$('#devices-attribute-popup-content').html(result.html);
												$('#devices_attribute_save').mage('validation', {});
												$(successMessage + ' .content').html(result.message);
												$(successMessage).show();
											} else {
												$(errorMessage + ' .content').html(result.message);
												$(errorMessage).show();
											}
										}
									});
								}
							}
						},
						{
							text: $.mage.__('Cancel'),
							click: function (event) {
								devicesModal.modal('closeModal');
							}
						}
					],
					opened: function () {
						$('#devices_attribute_save').mage('validation', {});
						window.switchScope = devicesSwitchScope;
					},
					closed: function(){
						$(successMessage).hide();
						$(errorMessage).hide();
					}
				});

			window.openDevicesModal = function(id){
				if(!$('#devices-store-switcher').length){
					$('.devices-save-button').closest('.page-main-actions').prepend('<div id="devices-store-switcher"></div>');
				}
				if(currentOption != id) {
					devicesAjaxUpdate({id: id});
				} else {
					devicesModal.modal('openModal');
				}
			};

			function devicesSwitchScope(obj) {
				var switcher = $(obj),
					scopeId = switcher.val();

				var param = {id: currentOption};
				param[switcher.data('param')] = scopeId;

				devicesAjaxUpdate(param);
			}

			function devicesAjaxUpdate(param){
				$.ajax({
					url: '<?php /* @escapeNotVerified */ echo $block->getDevicesUpdateUrl() ?>',
					type: 'POST',
					data: param,
					showLoader: true,
					success: function (response) {
						if (response.success) {
							$('#devices-attribute-popup-content').html(response.html);

							var storeSwitcher = $('#devices-store-switcher');
							storeSwitcher.html(response.switcher);
							storeSwitcher.trigger('contentUpdated');

							currentOption = param.id;
							devicesModal.modal('openModal');
						} else {
							alert(response.message);
						}
					}
				});
			}
		});
	</script>
	<style type="text/css">
		button[class*=devices_setting_option_]{
			display: none;
		}
	</style>
<?php endif; ?>
